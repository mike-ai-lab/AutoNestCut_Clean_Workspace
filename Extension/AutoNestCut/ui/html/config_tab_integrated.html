<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AutoNestCut</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="diagrams_style.css">
    <style>
        /* Additional styles for new design */
        .section {
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            margin-bottom: 40px;
        }
        .section-header {
            padding: 14px 18px;
            background: #f6f8fa;
            border-bottom: 1px solid #d0d7de;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .section-header:hover { background: #f1f5f9; }
        .section-title { font-size: 15px; font-weight: 600; color: #24292e; }
        .section-toggle { font-size: 13px; color: #656d76; }
        .section-content { 
            padding: 20px; 
            overflow: hidden;
            max-height: 1000px;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .section.collapsed .section-content { 
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        .section.collapsed .section-toggle::before { content: '▶'; }
        .section-toggle::before { content: '▼'; }
        
        /* Parts Preview - Horizontal Layout */
        .parts-preview-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
        }
        
        /* Table Container */
        .parts-table-container {
            flex: 1;
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            overflow: hidden;
        }
        .parts-table-header {
            padding: 16px 20px;
            background: #2323FF;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }
        .parts-table-scroll {
            overflow-y: auto;
            max-height: 600px;
        }
        
        /* Canvas Container */
        .parts-canvas-container {
            flex: 1;
            background: #ffffff;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .canvas-header {
            padding: 16px 20px;
            background: #2323FF;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }
        .canvas-viewport {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafbfc;
            position: relative;
            min-height: 500px;
        }
        #parts3DCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
            display: none;
        }
        #parts3DCanvas:active { cursor: grabbing; }
        #canvasPlaceholder {
            text-align: center;
            color: #656d76;
            padding: 40px;
            max-width: 300px;
        }
        #canvasPlaceholder p {
            font-size: 14px;
            line-height: 1.8;
            margin: 0;
        }
        .canvas-info {
            padding: 16px 20px;
            background: #f6f8fa;
            border-top: 1px solid #d0d7de;
            font-size: 12px;
            color: #656d76;
        }
        .canvas-info-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
        }
        .canvas-info-label { font-weight: 500; }
    </style>
    <script src="languages.js"></script>
</head>
<body>
    <!-- Header with tabs and buttons -->
    <div class="header">
        <div class="header-content">
            <h1>AutoNestCut</h1>
            <p class="developer-credit">by Int. Arch. M.Shkeir</p>
        </div>
        <div class="header-controls">
            <button class="settings-btn icon-btn" onclick="openSettings()" title="Settings">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m21-7h-6M7 5H1m21 7h-6M7 19H1"/>
                </svg>
            </button>
            <div class="action-buttons">
                <button class="tab-button" id="generateCutListButton" onclick="processNesting()">Generate Cut List</button>
                <button class="tab-button" id="refreshSelectionButton" onclick="refreshConfiguration()">Refresh Selection</button>
                <button class="tab-button" id="cancelButton" onclick="window.close()">Cancel</button>
                
                <!-- Report buttons - hidden by default -->
                <button class="tab-button icon-btn report-action-btn" id="refreshReportButton" onclick="refreshReportWithFeedback()" style="display: none;" title="Refresh Report">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                        <path d="M3 21v-5h5"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="exportCsvButton" style="display: none;" title="Export CSV">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="exportPdfButton" style="display: none;" title="Export PDF">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                </button>
                <button class="tab-button icon-btn report-action-btn" id="exportHtmlButton" style="display: none;" title="Export HTML">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                </button>
            </div>
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('config')">Configuration</button>
                <button class="tab-button" id="reportTab" onclick="showTab('report')" disabled>Report</button>
            </div>
        </div>
    </div>

    <!-- Configuration Tab -->
    <div id="configTab" class="tab-content active">
        <div class="config-container">
            
            <!-- Project Configuration -->
            <div class="section collapsed">
                <div class="section-header" onclick="toggleSection(this)">
                    <span class="section-title">Project Configuration</span>
                    <span class="section-toggle"></span>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Project Name</label>
                            <input type="text" id="project_name" placeholder="Enter project name">
                        </div>
                        <div class="form-group">
                            <label>Client Name</label>
                            <input type="text" id="client_name" placeholder="Enter client name">
                        </div>
                        <div class="form-group">
                            <label>Prepared By</label>
                            <input type="text" id="prepared_by" value="Int. Arch. M.Shkeir">
                        </div>
                        <div class="form-group">
                            <label>Kerf Width (mm)</label>
                            <input type="number" id="kerf_width" value="3.0" step="0.1">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="allow_rotation" checked>
                            <span style="font-size: 14px; color: #24292e;">Allow part rotation</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Selection Status -->
            <div class="section collapsed">
                <div class="section-header" onclick="toggleSection(this)">
                    <span class="section-title">Selection Status</span>
                    <span class="section-toggle"></span>
                </div>
                <div class="section-content">
                    <div id="selectionStatusTree" style="background: #f8fafc; border: 1px solid #d0d7de; border-radius: 5px; padding: 16px; max-height: 300px; overflow-y: auto; font-size: 13px;">
                        <p style="color: #656d76;">No selection detected. Please select components in SketchUp.</p>
                    </div>
                </div>
            </div>
            
            <!-- Components Found -->
            <div class="section collapsed">
                <div class="section-header" onclick="toggleSection(this)">
                    <span class="section-title">Components Found (<span id="totalComponentsCount">0</span>)</span>
                    <span class="section-toggle"></span>
                </div>
                <div class="section-content">
                    <div style="overflow-y: auto; max-height: 400px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th>Width (mm)</th>
                                    <th>Height (mm)</th>
                                    <th>Thickness (mm)</th>
                                    <th>Material</th>
                                </tr>
                            </thead>
                            <tbody id="componentsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #656d76; padding: 20px;">No components found</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- PARTS PREVIEW - Horizontal Layout -->
            <div class="parts-preview-wrapper">
                <!-- Table Container -->
                <div class="parts-table-container">
                    <div class="parts-table-header">
                        Parts Preview
                    </div>
                    <div class="parts-table-scroll">
                        <table>
                            <thead>
                                <tr>
                                    <th>Component Name</th>
                                    <th>Width (mm)</th>
                                    <th>Height (mm)</th>
                                    <th>Thickness (mm)</th>
                                    <th>Material</th>
                                    <th>Qty</th>
                                    <th>Area (m²)</th>
                                </tr>
                            </thead>
                            <tbody id="partsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: #656d76; padding: 20px;">No parts to display</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Canvas Container -->
                <div class="parts-canvas-container">
                    <div class="canvas-header">
                        3D Component Viewer
                    </div>
                    <div class="canvas-viewport">
                        <canvas id="parts3DCanvas"></canvas>
                        <div id="canvasPlaceholder">
                            <p style="margin-bottom: 8px;">Click any component to view in 3D</p>
                            <p style="opacity: 0.7;">Rotate: Left Click + Drag<br>Zoom: Scroll</p>
                        </div>
                    </div>
                    <div class="canvas-info">
                        <div class="canvas-info-row">
                            <span class="canvas-info-label">Selected:</span>
                            <span id="selectedPartName">None</span>
                        </div>
                        <div class="canvas-info-row">
                            <span class="canvas-info-label">Dimensions:</span>
                            <span id="selectedPartDims">-</span>
                        </div>
                        <div class="canvas-info-row">
                            <span class="canvas-info-label">Volume:</span>
                            <span id="selectedPartVolume">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stock Materials & Pricing -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span class="section-title">Stock Materials & Pricing</span>
                    <span class="section-toggle"></span>
                </div>
                <div class="section-content">
                    <div style="background: #f8fafc; border-bottom: 1px solid #e1e5e9; padding: 16px 24px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: -20px -20px 20px -20px;">
                        <button type="button" onclick="addMaterial()" class="btn-sm">Add Material</button>
                        <button type="button" onclick="loadDefaults()" class="btn-sm">Load Defaults</button>
                        <button type="button" onclick="importCSV()" class="btn-sm">Import CSV</button>
                        <button type="button" onclick="exportDatabase()" class="btn-sm">Export Database</button>
                        <div style="width: 1px; height: 24px; background: #d0d7de; margin: 0 4px;"></div>
                        <button type="button" id="foldToggle" onclick="toggleFold()" class="btn-sm">Used Only</button>
                        <button type="button" onclick="clearHighlight()" class="btn-sm">Clear Highlight</button>
                        <select id="sortBy" onchange="displayMaterials()" style="padding: 8px 12px; border: 1px solid #d0d7de; border-radius: 6px; font-size: 13px; background: white;">
                            <option value="alphabetical">Sort: A-Z</option>
                            <option value="usage">Sort: Used First</option>
                            <option value="mostUsed">Sort: Most Used</option>
                        </select>
                    </div>
                    <table id="materialsTable">
                        <thead>
                            <tr>
                                <th>Material Name</th>
                                <th>Width (mm)</th>
                                <th>Height (mm)</th>
                                <th>Thickness (mm)</th>
                                <th>Density (kg/m³)</th>
                                <th>Price per Sheet</th>
                                <th style="text-align: center;">Actions</th>
                                <th style="text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="materials_tbody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: #656d76; padding: 20px;">No materials available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Report Tab (from original main.html) -->
    <div id="reportTabContent" class="tab-content">
        <div class="container">
            <div id="diagramsContainer" class="diagrams-container">
                <p>Generate a report to view diagrams...</p>
            </div>
            <div class="resizer" id="resizer"></div>
            <div id="reportContainer" class="report-container">
                <h2>Materials Used</h2>
                <div class="table-with-controls">
                    <div class="table-controls">
                        <button class="icon-btn" onclick="copyTableAsMarkdown('materialsUsedTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                    <table id="materialsUsedTable"></table>
                </div>
                
                <h2>Overall Summary</h2>
                <div class="table-with-controls">
                    <div class="table-controls">
                        <button class="icon-btn" onclick="copyTableAsMarkdown('summaryTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                    <table id="summaryTable"></table>
                </div>
                
                <h2>Unique Part Types</h2>
                <div class="table-with-controls">
                    <div class="table-controls">
                        <button class="icon-btn" onclick="copyTableAsMarkdown('uniquePartTypesTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                    <table id="uniquePartTypesTable"></table>
                </div>
                
                <h2>Sheet Inventory Summary</h2>
                <div class="table-with-controls">
                    <div class="table-controls">
                        <button class="icon-btn" onclick="copyTableAsMarkdown('sheetInventoryTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                    <table id="sheetInventoryTable"></table>
                </div>
                
                <h2>Cut Sequences</h2>
                <div id="cutSequenceContainer"></div>
                
                <h2>Usable Offcuts</h2>
                <div class="table-with-controls">
                    <div class="table-controls">
                        <button class="icon-btn" onclick="copyTableAsMarkdown('offcutsTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                    <table id="offcutsTable"></table>
                </div>
                
                <div id="assemblyViewsContainer"></div>
                
                <h2>Cut List & Part Details</h2>
                <div class="tree-controls">
                    <button type="button" id="treeToggle" onclick="toggleTreeView()">Show Tree Structure</button>
                    <div class="tree-search" id="treeSearchContainer" style="display: none;">
                        <input type="text" id="treeSearch" placeholder="Search components..." oninput="filterTree()">
                        <button type="button" onclick="clearTreeSearch()">Clear</button>
                        <button type="button" onclick="expandAll()">Expand All</button>
                        <button type="button" onclick="collapseAll()">Collapse All</button>
                    </div>
                </div>
                <div id="treeStructure" class="tree-structure" style="display: none;"></div>
                <div class="table-with-controls">
                    <div class="table-controls">
                        <button class="icon-btn" onclick="copyTableAsMarkdown('partsTable')" title="Copy Markdown">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                            </svg>
                        </button>
                    </div>
                    <table id="partsTable"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal (from original) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettings()">&times;</span>
            <div class="settings-section">
                <h3>Units</h3>
                <select id="settingsUnits" class="sort-select">
                    <option value="mm">Millimeters (mm)</option>
                    <option value="cm">Centimeters (cm)</option>
                    <option value="m">Meters (m)</option>
                    <option value="in">Inches (in)</option>
                    <option value="ft">Feet (ft)</option>
                </select>
                <button onclick="updateUnits()">Update</button>
            </div>
            <div class="settings-section">
                <h3>Default Currency</h3>
                <select id="settingsCurrency" class="sort-select">
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="SAR">SAR (ر.س)</option>
                    <option value="AED">AED (د.إ)</option>
                    <option value="GBP">GBP (£)</option>
                </select>
                <button onclick="updateCurrency()">Update</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Global functions - must be defined before app.js loads
        let canvas3DScene, canvas3DCamera, canvas3DRenderer, canvas3DCurrentMesh;
        
        function showProgressOverlay(message) {
            let overlay = document.getElementById('progressOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'progressOverlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                overlay.innerHTML = '<div style="background: white; padding: 30px; border-radius: 8px; text-align: center; min-width: 300px;"><div id="progressMessage" style="font-size: 16px; margin-bottom: 15px;"></div><div style="width: 100%; height: 4px; background: #e1e5e9; border-radius: 2px; overflow: hidden;"><div id="progressBar" style="width: 0%; height: 100%; background: #2323FF; transition: width 0.3s;"></div></div></div>';
                document.body.appendChild(overlay);
            }
            document.getElementById('progressMessage').textContent = message || 'Processing...';
            overlay.style.display = 'flex';
        }
        
        function updateProgressOverlay(message, percent) {
            const msgEl = document.getElementById('progressMessage');
            const barEl = document.getElementById('progressBar');
            if (msgEl) msgEl.textContent = message || 'Processing...';
            if (barEl && typeof percent === 'number') barEl.style.width = percent + '%';
        }
        
        function hideProgressOverlay() {
            const overlay = document.getElementById('progressOverlay');
            if (overlay) overlay.style.display = 'none';
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            
            if (tabName === 'config') {
                document.getElementById('configTab').classList.add('active');
                document.querySelector('.tab-button[onclick*="config"]').classList.add('active');
                document.querySelectorAll('.report-action-btn').forEach(b => b.style.display = 'none');
                document.getElementById('generateCutListButton').style.display = 'inline-block';
                document.getElementById('refreshSelectionButton').style.display = 'inline-block';
                document.getElementById('cancelButton').style.display = 'inline-block';
            } else if (tabName === 'report') {
                document.getElementById('reportTabContent').classList.add('active');
                document.getElementById('reportTab').classList.add('active');
                document.querySelectorAll('.report-action-btn').forEach(b => b.style.display = 'inline-block');
                document.getElementById('generateCutListButton').style.display = 'none';
                document.getElementById('refreshSelectionButton').style.display = 'none';
                document.getElementById('cancelButton').style.display = 'none';
            }
        }
        
        function showReportTab() {
            document.getElementById('reportTab').disabled = false;
            showTab('report');
        }
        
        function refreshConfiguration() {
            callRuby('refresh_selection');
        }
        
        function refreshReportWithFeedback() {
            showProgressOverlay('Refreshing report...');
            setTimeout(() => {
                if (typeof renderReport === 'function') renderReport();
                if (typeof renderDiagrams === 'function') renderDiagrams();
                hideProgressOverlay();
            }, 500);
        }
        
        function toggleSection(header) {
            header.parentElement.classList.toggle('collapsed');
        }
        
        function init3DCanvas() {
            const canvas = document.getElementById('parts3DCanvas');
            const container = canvas.parentElement;
            
            canvas3DScene = new THREE.Scene();
            canvas3DScene.background = new THREE.Color(0xfafbfc);
            
            canvas3DCamera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 10000);
            canvas3DCamera.position.set(1000, 800, 1000);
            canvas3DCamera.lookAt(0, 0, 0);
            
            canvas3DRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            canvas3DRenderer.setSize(container.clientWidth, container.clientHeight);
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            canvas3DScene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(500, 1000, 500);
            canvas3DScene.add(directionalLight);
            
            const gridHelper = new THREE.GridHelper(2000, 20, 0xcccccc, 0xeeeeee);
            canvas3DScene.add(gridHelper);
            
            animate3DCanvas();
        }
        
        function selectPart(row, name, width, height, thickness) {
            document.querySelectorAll('#partsTableBody tr').forEach(r => r.classList.remove('selected'));
            row.classList.add('selected');
            
            document.getElementById('canvasPlaceholder').style.display = 'none';
            document.getElementById('parts3DCanvas').style.display = 'block';
            
            document.getElementById('selectedPartName').textContent = name;
            document.getElementById('selectedPartDims').textContent = `${width} × ${height} × ${thickness} mm`;
            const volume = (width * height * thickness / 1000000000).toFixed(4);
            document.getElementById('selectedPartVolume').textContent = `${volume} m³`;
            
            if (canvas3DCurrentMesh) canvas3DScene.remove(canvas3DCurrentMesh);
            
            const geometry = new THREE.BoxGeometry(width, thickness, height);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x2323FF, 
                transparent: true, 
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            canvas3DCurrentMesh = new THREE.Mesh(geometry, material);
            
            const edges = new THREE.EdgesGeometry(geometry);
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 });
            const wireframe = new THREE.LineSegments(edges, lineMaterial);
            canvas3DCurrentMesh.add(wireframe);
            
            canvas3DScene.add(canvas3DCurrentMesh);
            
            const maxDim = Math.max(width, height, thickness);
            canvas3DCamera.position.set(maxDim * 1.5, maxDim * 1.2, maxDim * 1.5);
            canvas3DCamera.lookAt(0, 0, 0);
            
            const container = document.getElementById('parts3DCanvas').parentElement;
            canvas3DRenderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        function animate3DCanvas() {
            requestAnimationFrame(animate3DCanvas);
            if (canvas3DCurrentMesh) {
                canvas3DCurrentMesh.rotation.y += 0.005;
            }
            canvas3DRenderer.render(canvas3DScene, canvas3DCamera);
        }
        
        window.addEventListener('load', () => {
            init3DCanvas();
            if (typeof callRuby === 'function') callRuby('ready');
        });
        
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('parts3DCanvas');
            const container = canvas.parentElement;
            canvas3DCamera.aspect = container.clientWidth / container.clientHeight;
            canvas3DCamera.updateProjectionMatrix();
            canvas3DRenderer.setSize(container.clientWidth, container.clientHeight);
        });
    </script>
    <script src="app.js"></script>
    <script src="diagrams_report.js"></script>
    <script src="resizer_fix.js"></script>
</body>
</html>
